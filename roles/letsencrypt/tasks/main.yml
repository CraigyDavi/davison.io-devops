- name: Add Certbot PPA
  apt_repository:
    repo: ppa:certbot/certbot
    update_cache: yes

- name: Install Certbot
  apt:
    name: certbot
    state: latest

- name: Create nginx ssl directory
  file:
    path: /etc/nginx/ssl
    state: directory

- name: Check if ticket.key exists
  stat:
    path: /etc/nginx/ssl/ticket.key
  register: ticketkey

- name: Generate ticket.key
  command: openssl rand -out /etc/nginx/ssl/ticket.key 48
  when: not ticketkey.stat.exists

- name: Check if dhparam.pem exists
  stat:
    path: /etc/nginx/ssl/dhparam.pem
  register: dhparampem

- name: Generate dhparam.pem
  command: openssl dhparam -out /etc/nginx/ssl/dhparam.pem 4096
  when: not dhparampem.stat.exists

- name: Register certificates
  command: {{ letsencrypt_certs.command }}
  with_items: {{ letsencrypt_certs }}

- name: Add renew cronjob
  cron:
    name: "letsencrypt-renew"
    job: "/usr/bin/certbot renew --pre-hook "{{ letsencrypt_pre_renew }}" --post-hook "{{ letsencrypt_post_renew }}""
    special_time: weekly
    state: present
